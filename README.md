<div align="center">

# ğŸ§  æ™ºèƒ½LLMåˆ¤æ–­ (Smart Judge)

[![AstrBot](https://img.shields.io/badge/AstrBot-Plugin-purple)](https://github.com/Soulter/AstrBot)
[![License](https://img.shields.io/badge/license-MIT-green)](./LICENSE)
[![Python](https://img.shields.io/badge/python-3.6+-blue)](https://www.python.org/)

**è®©æ¯ä¸€åˆ†Tokenéƒ½èŠ±åœ¨åˆ€åˆƒä¸Š**

æ™ºèƒ½åˆ†æç”¨æˆ·æ„å›¾ â€¢ åŠ¨æ€è·¯ç”±æ¨¡å‹ â€¢ é™ä½APIæˆæœ¬ â€¢ æå‡å“åº”é€Ÿåº¦

</div>

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ§  æ™ºèƒ½åˆ†æµ**ï¼šè‡ªåŠ¨è¯†åˆ«"å¼±æ™º"é—®é¢˜ä¸"çƒ§è„‘"é—®é¢˜ï¼Œåˆ†åˆ«è·¯ç”±è‡³å¿«é€Ÿæ¨¡å‹æˆ–é«˜æ™ºå•†æ¨¡å‹ã€‚
- **âš–ï¸ è´Ÿè½½å‡è¡¡**ï¼šæ”¯æŒé…ç½®å¤šä¸ªé«˜æ™ºå•†æ¨¡å‹æä¾›å•†ï¼Œéšæœº/è½®è¯¢è°ƒç”¨ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚
- **ğŸ›¡ï¸ è§„åˆ™å…œåº•**ï¼šå½“åˆ¤æ–­æ¨¡å‹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é™çº§ä¸ºå…³é”®è¯/æ­£åˆ™åŒ¹é…æ¨¡å¼ã€‚
- **ğŸ’° é¢„ç®—æ§åˆ¶**ï¼šå†…ç½®æ¯æ—¥/æ¯æœˆé¢„ç®—é™åˆ¶ï¼Œé˜²æ­¢Tokenè¶…æ”¯ã€‚
- **ğŸ“ ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šæ”¯æŒæºå¸¦èŠå¤©è®°å½•è¿›è¡Œåˆ¤æ–­ï¼Œç†è§£æ›´ç²¾å‡†ã€‚
- **âš¡ é«˜æ•ˆç¼“å­˜**ï¼šè‡ªåŠ¨ç¼“å­˜ç›¸ä¼¼é—®é¢˜çš„åˆ¤æ–­ç»“æœï¼Œå‡å°‘é‡å¤å¼€é”€ã€‚

## ğŸ§© å·¥ä½œåŸç†

æ’ä»¶åœ¨æ¯æ¬¡ LLM è°ƒç”¨å‰æ‹¦æˆªè¯·æ±‚ï¼Œæ ¹æ®â€œå¤æ‚åº¦åˆ¤å®šâ€å†³å®šèµ° HIGH æ± æˆ– FAST æ± ï¼Œå¹¶å¯å åŠ ç­–ç•¥ä¸ä¿æŠ¤æœºåˆ¶ï¼š

1) **è§„åˆ™é¢„åˆ¤**ï¼šå…ˆç”¨å…³é”®è¯/æ­£åˆ™å¿«é€Ÿåˆ¤å®šï¼ˆå¯ç¼–è¾‘ `resources/judge_keywords.json`ï¼Œä¹Ÿæ”¯æŒ `custom_*_keywords`ï¼‰ã€‚
2) **æ¨¡å‹åˆ¤å®š**ï¼šè‹¥è§„åˆ™æ— æ³•åˆ¤å®šï¼Œåˆ™è°ƒç”¨ `judge_provider_id` å¯¹æ¶ˆæ¯äºŒåˆ†ç±»ï¼ˆä»…è¾“å‡º HIGH/FASTï¼‰ã€‚
3) **è·¯ç”±é€‰æ‹©**ï¼šç»“åˆé»‘ç™½åå•ã€ä¼šè¯é”å®šã€FAST_ONLY/HIGH_ONLY ç­–ç•¥ã€é¢„ç®—æ§åˆ¶ä¸æ–­è·¯å™¨ï¼Œé€‰æ‹©æœ€ç»ˆ provider/model å¹¶å†™å›åˆ°è¯·æ±‚ã€‚
4) **ç»Ÿè®¡ä¸è§£é‡Š**ï¼šè®°å½•æœ€è¿‘ä¸€æ¬¡è·¯ç”±å…ƒä¿¡æ¯ï¼Œæ”¯æŒ `/judge_stats` ä¸ `/judge_explain` æŸ¥çœ‹å‘½ä¸­åŸå› ä¸æ‰§è¡Œæƒ…å†µã€‚

## ğŸ§± æ¨¡å—èŒè´£

ä»£ç æŒ‰ Mixin æ‹†åˆ†ï¼Œæ¯ä¸ªæ–‡ä»¶å°½é‡åªè´Ÿè´£ä¸€ç±»èƒ½åŠ›ï¼ˆä¾¿äºç»´æŠ¤ä¸æ‰©å±•ï¼‰ï¼š

- `judge_hooks.py`ï¼šLLM è¯·æ±‚/å“åº”é’©å­ï¼Œè´Ÿè´£è·¯ç”±æ‹¦æˆªã€pending å…³è”ã€æ–­è·¯å™¨æ›´æ–°ä¸ç»Ÿè®¡æ‰“ç‚¹ã€‚
- `judge_decider.py`ï¼šå¤æ‚åº¦åˆ¤å®šï¼ˆè§„åˆ™é¢„åˆ¤ â†’ LLM åˆ¤å®š â†’ fallbackï¼‰ä¸å†³ç­–ç¼“å­˜ã€‚
- `judge_router.py`ï¼šæ± é€‰æ‹©ã€ç­–ç•¥/é”å®šè¦†ç›–ã€æ–­è·¯å™¨æ£€æŸ¥ä¸è‡ªåŠ¨ fallbackã€‚
- `judge_commands.py`ï¼šç®¡ç†ä¸è°ƒè¯•å‘½ä»¤ï¼ˆstatus/stats/health/explain/rule/dryrun/ask_*ï¼‰ã€‚
- `judge_config.py`ï¼šé…ç½®å½’ä¸€åŒ–ä¸æ ¡éªŒï¼ˆåªæŠ¥å‘Š error/warnï¼Œä¸å¼ºåˆ¶æ”¹è¡Œä¸ºï¼‰ã€‚
- `judge_acl.py`ï¼šé»‘ç™½åå•ä¸å‘½ä»¤ ACLã€‚
- `judge_budget.py`ï¼šé¢„ç®—æ¨¡å¼ä¸è§¦å‘æ¯”ä¾‹æ§åˆ¶ã€‚
- `judge_lock.py`ï¼šä¼šè¯çº§ä¸´æ—¶é”å®šä¸è¿‡æœŸæ¸…ç†ã€‚
- `judge_context.py`ï¼šå‘½ä»¤ä¸Šä¸‹æ–‡çš„è¯»å–/å†™å›ä¸å¤§å†å²è§£æé™é˜»å¡ã€‚
- `judge_rules.py`ï¼šè§„åˆ™åŒ¹é…ä¸å…³é”®è¯ç»´æŠ¤ï¼ˆé»˜è®¤è§„åˆ™å¯åœ¨ `resources/judge_keywords.json` è°ƒæ•´ï¼‰ã€‚

## ğŸ› ï¸ æŒ‡ä»¤åˆ—è¡¨

æ’ä»¶å®‰è£…åå³å¯è‡ªåŠ¨ç”Ÿæ•ˆã€‚ä»¥ä¸‹ä¸ºæŒ‡ä»¤åˆ—è¡¨ï¼ˆæ”¯æŒåˆ«åï¼‰ï¼š

| æŒ‡ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
| :--- | :--- | :--- |
| `/judge_status` | æŸ¥çœ‹æ’ä»¶çŠ¶æ€ | `/judge_status` |
| `/judge_stats` | æŸ¥çœ‹è·¯ç”±ä¸ LLM ç»Ÿè®¡ | `/judge_stats` |
| `/judge_health` | æ¢æµ‹æä¾›å•†å¥åº·åº¦/æ–­è·¯å™¨ | `/judge_health` |
| `/judge_explain` | è§£é‡Šæœ€è¿‘ä¸€æ¬¡è·¯ç”±å†³ç­– | `/judge_explain` |
| `/judge_rule` | å¢åˆ åˆ—å‡ºè‡ªå®šä¹‰å…³é”®è¯è§„åˆ™ | `/judge_rule list` |
| `/judge_dryrun` | æ¨¡æ‹Ÿä¸€æ®µæ¶ˆæ¯å°†å¦‚ä½•è·¯ç”± | `/judge_dryrun å¸®æˆ‘å†™ä¸ªä»£ç ` |
| `/ask_high` | å¼ºåˆ¶èµ°é«˜æ™ºå•†æ±  | `/ask_high` |
| `/ask_fast` | å¼ºåˆ¶èµ°å¿«é€Ÿæ±  | `/ask_fast` |
| `/ask_smart` | æ™ºèƒ½åˆ¤å®šåè·¯ç”± | `/ask_smart` |

> ğŸ’¡ **æç¤º**ï¼šæ™®é€šç”¨æˆ·æ— éœ€è¾“å…¥ä»»ä½•æŒ‡ä»¤ï¼Œæ­£å¸¸å¯¹è¯å³å¯äº«å—æ™ºèƒ½è·¯ç”±æœåŠ¡ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ä½äº `data/plugins/astrbot_plugin_judge/config.json`ã€‚

### æ ¸å¿ƒé…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | æ¨èå€¼ |
| :--- | :--- | :--- |
| `judge_provider_id` | **[å¿…å¡«]** åˆ¤æ–­æ¨¡å‹æä¾›å•†ID | `openai` / `anthropic` ç­‰ |
| `judge_model` | åˆ¤æ–­æ¨¡å‹åç§°(å¯é€‰) | `gpt-4o-mini` ç­‰ |
| `high_iq_provider_ids` | é«˜æ™ºå•†æ¨¡å‹æä¾›å•†åˆ—è¡¨ | `["openai","anthropic"]` |
| `high_iq_models` | ä¸é«˜æ™ºå•†æä¾›å•†ä¸€ä¸€å¯¹åº”çš„æ¨¡å‹ååˆ—è¡¨ | `["gpt-4o","claude-3-opus"]` |
| `fast_provider_ids` | å¿«é€Ÿæ¨¡å‹æä¾›å•†åˆ—è¡¨ | `["openai","google"]` |
| `fast_models` | ä¸å¿«é€Ÿæä¾›å•†ä¸€ä¸€å¯¹åº”çš„æ¨¡å‹ååˆ—è¡¨ | `["gpt-4o-mini","gemini-1.5-flash"]` |

> å»ºè®®ä¼˜å…ˆä½¿ç”¨æ›´ç¨³å¥çš„é…å¯¹é…ç½®ï¼š`high_iq_routes` / `fast_routes`ï¼ˆä¾‹å¦‚ `"openai:gpt-4o"`ï¼‰ï¼Œé¿å… provider/models ä¸¤ä¸ªåˆ—è¡¨çš„ç´¢å¼•å¯¹é½è„†å¼±é—®é¢˜ã€‚

### é«˜çº§åŠŸèƒ½

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
| :--- | :--- | :--- |
| `enable_high_iq_polling` | é«˜æ™ºå•†æ± æ˜¯å¦è½®è¯¢é€‰æ‹© | `true` |
| `enable_rule_prejudge` | å¯ç”¨è§„åˆ™é¢„åˆ¤(å‡å°‘åˆ¤æ–­æ¨¡å‹è°ƒç”¨) | `true` |
| `enable_decision_cache` | å¯ç”¨å†³ç­–ç¼“å­˜ | `true` |
| `decision_cache_ttl_seconds` | å†³ç­–ç¼“å­˜ TTL(ç§’) | `600` |
| `enable_answer_cache` | å¯ç”¨å‘½ä»¤å›ç­”ç¼“å­˜ | `false` |
| `answer_cache_ttl_seconds` | å›ç­”ç¼“å­˜ TTL(ç§’) | `300` |

## â“ å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæ’ä»¶æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ**
> A: è¯·å…ˆç”¨ `/judge_status` æŸ¥çœ‹çŠ¶æ€ï¼Œå¹¶æ£€æŸ¥ `judge_provider_id` æ˜¯å¦å·²é…ç½®ã€‚

**Q: å¦‚ä½•è‡ªå®šä¹‰åˆ¤æ–­é€»è¾‘ï¼Ÿ**
> A: å¯é€šè¿‡é…ç½® `custom_high_keywords` / `custom_fast_keywords` æˆ–ä½¿ç”¨ `/judge_rule` å‘½ä»¤åŠ¨æ€å¢åˆ å…³é”®è¯è§„åˆ™ï¼›ä¹Ÿå¯ç›´æ¥ç¼–è¾‘æ’ä»¶ç›®å½•ä¸‹çš„ `resources/judge_keywords.json` æ¥è°ƒæ•´å†…ç½®å…³é”®è¯é›†åˆã€‚

**Q: é¢„ç®—è€—å°½äº†æ€ä¹ˆåŠï¼Ÿ**
> A: æ’ä»¶ä¼šåœ¨é¢„ç®—æ§åˆ¶å¯ç”¨æ—¶æŒ‰æ¨¡å¼é™çº§ä¸º FASTï¼›è°ƒæ•´é¢„ç®—ç›¸å…³é…ç½®åé‡å¯æ’ä»¶å³å¯ç”Ÿæ•ˆã€‚

---

<div align="center">
Made with â¤ï¸ for AstrBot

å–œæ¬¢ç‚¹ä¸ªstarå§~
</div>
